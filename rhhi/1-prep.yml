---
- hosts: rhhi
  name: Prepare systems before installing RHHI
  gather_facts: yes
  vars:
    activation_key: rnelson-rhhi
    rhn_org_id: 1979710
    pool: 8a85f9833e1404a9013e3cddf95a0599

  tasks:
  - name: Copy /etc/hosts file
    copy:
      src: etc-hosts
      dest: /etc/hosts
      mode: 0644
    tags: pre

  - name: Copy Ansible hosts file
    copy:
      src: ansible-hosts
      dest: /etc/ansible/hosts
      mode: 0644
    tags: pre

# NEED TO TEST
#  - name: ensure SSH key is generated
#    command: ssh-keygen -t rsa -f /root/.ssh/id_rsa -N ''
#    args:
#      creates: /root/.ssh/id_rsa

  - name: create ssh dir
    file:
      path: /root/.ssh
      state: directory
      owner: root
      group: root
      mode: 0700
    tags: keys

  - name: add id_rsa
    copy:
      src: files/id_rsa
      dest: /root/.ssh/id_rsa
      group: root
      owner: root
      mode: 0600
    tags: keys

  - name: add id_rsa.pub
    copy:
      src: files/id_rsa.pub
      dest: /root/.ssh/id_rsa.pub
      group: root
      owner: root
      mode: 0644
    tags: keys

  - name: Set authorized key
    authorized_key:
      user: root
      key: "{{ lookup('file', 'id_rsa.pub') }}"
    tags: keys

  - name: Install SSH public key
    authorized_key:
      user: root
      key: "{{ lookup('file', 'rnelson-homelab.pub') }}"
    tags: keys

#  - name: Create known_hosts
#    lineinfile:
#      path: /root/.ssh/known_hosts
#      create: yes
#      state: present
#      line: "{{ lookup('pipe', 'ssh-keyscan -t ecdsa-sha2-nistp256 '+item) }}"
#    with_items:
#      - rhhi1.rnelson-demo.com
#      - rhhi2.rnelson-demo.com
#      - rhhi3.rnelson-demo.com
#      - rhhi1-gluster.rnelson-demo.com
#      - rhhi2-gluster.rnelson-demo.com
#      - rhhi3-gluster.rnelson-demo.com
#    delegate_to: rhhi1.rnelson-demo.com
#    run_once: true
#    tags: hostkeys

  - name: Create known_hosts (task above preferred, but route table on VPN not working)
    shell: "ssh-keyscan -t ecdsa-sha2-nistp256 {{item}} >> /root/.ssh/known_hosts"
    with_items:
      - rhhi1.rnelson-demo.com
      - rhhi2.rnelson-demo.com
      - rhhi3.rnelson-demo.com
      - rhhi1-gluster.rnelson-demo.com
      - rhhi2-gluster.rnelson-demo.com
      - rhhi3-gluster.rnelson-demo.com
    delegate_to: rhhi1.rnelson-demo.com
    run_once: true
    tags: hostkeys

  - name: Register
    command: subscription-manager register --activationkey={{activation_key}} --org={{rhn_org_id}}
    ignore_errors: yes #Added this because I'm using the Employee SKU, which doesn't match the auto-attach for RHV-H.
    tags: register

  - name: Attach
    command: subscription-manager attach --pool={{pool}}
    tags: register

  - name: Disable All and Enable Specific Repositories
    command: subscription-manager repos --disable="*" --enable=rhel-7-server-rhvh-4-rpms
    tags: register
